<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è±¡è©•ä¾¡ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; text-align: center; background-color: #f4f7f6; padding: 20px; color: #333; }
        h2 { margin-bottom: 10px; }
        p { line-height: 1.6; }
        
        .screen { display: none; width: 100%; margin: 0 auto; background: white; padding: 30px 10px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .active { display: block; }
        
        #start-screen, #break-screen, #device-screen, #finish-screen { max-width: 600px; }

        button.btn-primary {
            background-color: #007bff; color: white; border: none; padding: 15px 40px;
            font-size: 18px; border-radius: 5px; cursor: pointer; margin-top: 30px;
            transition: background 0.3s;
        }
        button.btn-primary:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .container { 
            display: flex; justify-content: center; gap: 20px; margin-top: 20px; 
            flex-wrap: wrap; width: 100%; 
        }
        .image-card {
            background: #fff; padding: 5px; border-radius: 8px; border: 2px solid #ddd;
            cursor: pointer; transition: transform 0.2s, border-color 0.2s;
            width: 48%; max-width: none; 
        }
        .image-card:hover { transform: scale(1.01); border-color: #007bff; box-shadow: 0 0 15px rgba(0,123,255,0.4); }
        img { width: 100%; height: auto; border-radius: 4px; display: block; }
        
        .radio-group { text-align: left; margin: 20px auto; display: inline-block; }
        .radio-item { margin: 10px 0; font-size: 16px; }
        input[type="radio"] { transform: scale(1.2); margin-right: 10px; }

        .progress { margin-top: 15px; font-size: 1.1em; color: #777; font-weight: bold;}
        .category-badge {
            background: #e9ecef; color: #495057; padding: 5px 15px; 
            border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-bottom: 10px; display: inline-block;
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen active">
        <h2>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã”å”åŠ›ã®ãŠé¡˜ã„</h2>
        <p>ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§ã¯ã€ç”»åƒã®å°è±¡ã«ã¤ã„ã¦<br><strong>3ã¤ã®ç•°ãªã‚‹è¦³ç‚¹</strong>ã‹ã‚‰æ¯”è¼ƒè©•ä¾¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #ffeeba;">
            <p class="note">ã€é‡è¦ã€‘</p>
            <p>PCã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãªã©ã€ç”»é¢ã®å¤§ãã„ãƒ‡ãƒã‚¤ã‚¹ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        <button class="btn-primary" onclick="startSurvey()">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div id="break-screen" class="screen">
        <h2>æ¬¡ã®é …ç›®ã¸é€²ã¿ã¾ã™</h2>
        <p>æ¬¡ã¯ä»¥ä¸‹ã®è¦³ç‚¹ã§é¸ã‚“ã§ãã ã•ã„ï¼š</p>
        <h3 id="next-category-title" style="color: #007bff; font-size: 1.5em;"></h3>
        <p>æº–å‚™ãŒã§ããŸã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <button class="btn-primary" onclick="startNextSection()">æ¬¡ã¸</button>
    </div>

    <div id="quiz-screen" class="screen">
        <span class="category-badge" id="category-badge">ã‚«ãƒ†ã‚´ãƒªå</span>
        <h2 id="question-text">ã©ã¡ã‚‰ãŒã‚ˆã‚Šã€‡ã€‡ã§ã™ã‹ï¼Ÿ</h2>
        <p>ç›´æ„Ÿã§ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
        
        <div class="container">
            <div class="image-card" onclick="selectImage('A')">
                <img id="imgA" src="" alt="ç”»åƒA">
            </div>
            <div class="image-card" onclick="selectImage('B')">
                <img id="imgB" src="" alt="ç”»åƒB">
            </div>
        </div>
        <p class="progress"><span id="current-count">0</span> / <span id="max-count">0</span> å•ç›®</p>
    </div>

    <div id="device-screen" class="screen">
        <h2>ã™ã¹ã¦ã®æ¯”è¼ƒãŒçµ‚äº†ã—ã¾ã—ãŸ</h2>
        <p>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>æœ€å¾Œã«ã€ç¾åœ¨å›ç­”ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>
        <div class="radio-group">
            <div class="radio-item"><label><input type="radio" name="device" value="PC"> PC (ãƒãƒ¼ãƒˆ/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—)</label></div>
            <div class="radio-item"><label><input type="radio" name="device" value="Tablet"> ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ (iPadãªã©)</label></div>
            <div class="radio-item"><label><input type="radio" name="device" value="Smartphone"> ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³</label></div>
            <div class="radio-item"><label><input type="radio" name="device" value="Other"> ãã®ä»–</label></div>
        </div>
        <br>
        <button id="send-btn" class="btn-primary" onclick="submitDevice()" disabled>é€ä¿¡ã—ã¦çµ‚äº†</button>
    </div>

    <div id="finish-screen" class="screen">
        <h2>é€ä¿¡å®Œäº†</h2>
        <p>ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚<br>ç”»é¢ã‚’é–‰ã˜ã¦çµ‚äº†ã—ã¦ãã ã•ã„ã€‚</p>
        <p style="font-size:40px;">ğŸ™‡â€â™‚ï¸</p>
    </div>

    <script>
        // ==========================================
        // â–¼ è¨­å®šã‚¨ãƒªã‚¢
        // ==========================================
        
        // â˜…ã“ã“ã«GASã®URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzbTUKNskWjikudI7fJqFX2GZfgtjF7OdVcn9kKCsDQTPQS7vK-aNt5sOB9N6rw8vQcug/exec";
        
        // ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
        const imagePath = "kenkyu/1/";

        // ç”»åƒãƒªã‚¹ãƒˆ
        const imageList = [
            "1100.png", "2300.png", "9500.png", "19000.png",
            "38000.png", "75000.png", "150000.png", "300000.png",
            "600000.png", "1200000.png", "2400000.png", "4600000.png",
            "8800000.png", "15000000.png", "25000000.png", "origin38000000.png"
        ];
        
        // 1ã¤ã®é …ç›®ã‚ãŸã‚Šã®è³ªå•æ•°
        const maxQuestionsPerCategory = 10; 

        // è©•ä¾¡é …ç›®ã®è¨­å®šï¼ˆã“ã“ã‚’å¤‰ãˆã‚Œã°é …ç›®ã‚’å¢—ã‚„ã›ã¾ã™ï¼‰
        const stages = [
            { id: "uncanny", label: "ä¸æ°—å‘³ãƒ»ææ€–", question: "ã©ã¡ã‚‰ãŒã€Œã‚ˆã‚Šä¸æ°—å‘³ã€ã§ã™ã‹ï¼Ÿ" },
            { id: "disgust", label: "ä¸å¿«ãƒ»å«Œæ‚ª",   question: "ã©ã¡ã‚‰ãŒã€Œã‚ˆã‚Šä¸å¿«ã€ã§ã™ã‹ï¼Ÿ" },
            { id: "affinity", label: "è¦ªå’Œæ„Ÿãƒ»å¥½æ„Ÿ", question: "ã©ã¡ã‚‰ã«ã€Œã‚ˆã‚Šå¥½æ„Ÿã€ã‚’æŒã¦ã¾ã™ã‹ï¼Ÿ" }
        ];

        // ==========================================
        // â–² è¨­å®šã“ã“ã¾ã§
        // ==========================================

        let currentStageIndex = 0; // ä»Šã©ã®é …ç›®ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹
        let currentCount = 0;
        const userId = "user_" + Math.random().toString(36).substr(2, 9);
        let currentPair = {};

        window.onload = function() {
            document.getElementById("max-count").textContent = maxQuestionsPerCategory;
            
            const radios = document.getElementsByName("device");
            for(let radio of radios) {
                radio.addEventListener('change', function() {
                    document.getElementById("send-btn").disabled = false;
                });
            }
        };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // æœ€åˆã®é–‹å§‹ãƒœã‚¿ãƒ³
        function startSurvey() {
            // æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®æº–å‚™
            setupStage(0);
            showScreen('quiz-screen');
            showNextPair();
        }

        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®åˆ‡ã‚Šæ›¿ãˆç”»é¢ã‚’è¡¨ç¤º
        function showBreakScreen() {
            const nextStage = stages[currentStageIndex];
            document.getElementById("next-category-title").textContent = `ã€Œ${nextStage.label}ã€`;
            showScreen('break-screen');
        }

        // ä¼‘æ†©ç”»é¢ã‹ã‚‰æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³
        function startNextSection() {
            setupStage(currentStageIndex);
            showScreen('quiz-screen');
            showNextPair();
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã®ã‚»ãƒƒãƒˆ
        function setupStage(index) {
            const stage = stages[index];
            document.getElementById("category-badge").textContent = `ç¾åœ¨ã®ãƒ†ãƒ¼ãƒï¼š${stage.label}`;
            document.getElementById("question-text").textContent = stage.question;
            currentCount = 0;
            document.getElementById("current-count").textContent = 0;
        }

        // æ¬¡ã®ãƒšã‚¢ã‚’è¡¨ç¤º
        function showNextPair() {
            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¦å®šå›æ•°ãŒçµ‚ã‚ã£ãŸã‚‰
            if (currentCount >= maxQuestionsPerCategory) {
                currentStageIndex++; // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸

                if (currentStageIndex < stages.length) {
                    // ã¾ã æ¬¡ã®é …ç›®ãŒã‚ã‚‹å ´åˆ -> ä¼‘æ†©ç”»é¢ã¸
                    showBreakScreen();
                } else {
                    // å…¨éƒ¨ã®é …ç›®ãŒçµ‚ã‚ã£ãŸå ´åˆ -> ãƒ‡ãƒã‚¤ã‚¹ç¢ºèªã¸
                    showScreen('device-screen');
                }
                return;
            }

            let idx1 = Math.floor(Math.random() * imageList.length);
            let idx2 = Math.floor(Math.random() * imageList.length);
            while (idx1 === idx2) {
                idx2 = Math.floor(Math.random() * imageList.length);
            }

            currentPair = { fileA: imageList[idx1], fileB: imageList[idx2] };

            document.getElementById("imgA").src = imagePath + currentPair.fileA;
            document.getElementById("imgB").src = imagePath + currentPair.fileB;

            currentCount++;
            document.getElementById("current-count").textContent = currentCount;
        }

        // ç”»åƒé¸æŠæ™‚ã®é€ä¿¡
        function selectImage(choice) {
            const winnerFile = (choice === 'A') ? currentPair.fileA : currentPair.fileB;
            const currentStage = stages[currentStageIndex];
            
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({
                    type: "comparison",
                    userId: userId,
                    category: currentStage.id, // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒª(uncanny, disgustç­‰)ã‚’é€ã‚‹
                    imgA: currentPair.fileA,
                    imgB: currentPair.fileB,
                    winner: winnerFile
                })
            });

            showNextPair();
        }

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®é€ä¿¡
        function submitDevice() {
            const radios = document.getElementsByName("device");
            let selectedDevice = "";
            for(let radio of radios) {
                if(radio.checked) {
                    selectedDevice = radio.value;
                    break;
                }
            }
            if (selectedDevice === "") {
                alert("ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            const btn = document.getElementById("send-btn");
            btn.disabled = true;
            btn.textContent = "é€ä¿¡ä¸­...";

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({
                    type: "device",
                    userId: userId,
                    device: selectedDevice
                })
            }).then(() => {
                showScreen('finish-screen');
            }).catch(() => {
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>